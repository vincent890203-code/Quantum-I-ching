<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>è©³ç´°è³‡æ–™æµç¨‹åœ–

### ä¸»è¦æµç¨‹ï¼šä½¿ç”¨è€…æŸ¥è©¢ â†’ Oracle è§£è®€</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .mermaid {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>è©³ç´°è³‡æ–™æµç¨‹åœ–

### ä¸»è¦æµç¨‹ï¼šä½¿ç”¨è€…æŸ¥è©¢ â†’ Oracle è§£è®€</h1>
    <div class="mermaid">
sequenceDiagram
    autonumber
    participant U as ğŸ‘¤ ä½¿ç”¨è€…
    participant D as ğŸ“± Dashboard
    participant DL as ğŸ“Š MarketDataLoader
    participant ME as ğŸ”¢ MarketEncoder
    participant IC as ğŸ”¢ IChingCore
    participant O as ğŸ”® Oracle
    participant VS as ğŸ“š VectorStore
    participant J as ğŸ“„ iching_complete.json
    participant G as ğŸ¤– Gemini API

    U->>D: è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ/å•é¡Œ
    D->>DL: fetch_data(ticker, market_type)
    DL->>DL: æ ¼å¼åŒ– ticker<br/>(ä¾‹å¦‚ 2330 â†’ 2330.TW)
    DL-->>D: raw_df (OHLCV)
    
    D->>ME: generate_hexagrams(raw_df)
    ME->>ME: è¨ˆç®—æŠ€è¡“æŒ‡æ¨™<br/>(RVOL, RVOL_Percentile)
    ME->>ME: å¤§è¡ä¹‹æ•¸æ˜ å°„<br/>(RVOL â†’ 6/7/8/9)
    ME->>ME: æ»¾å‹•çª—å£(6å¤©)<br/>â†’ Ritual_Sequence
    ME->>IC: è¨ˆç®—æœ¬å¦/ä¹‹å¦
    IC-->>ME: æœ¬å¦/ä¹‹å¦è³‡è¨Š
    ME-->>D: encoded_df<br/>(å« Ritual_Sequence)
    
    D->>IC: interpret_sequence(ritual_sequence)
    IC-->>D: current_hex, future_hex, moving_lines
    
    D->>D: çµ„æˆ current_market_state
    D->>D: ç•« K ç·šåœ–ã€å¦è±¡è¦–è¦ºåŒ–
    
    D->>O: ask(ticker, question,<br/>precomputed_data)
    O->>O: _resolve_strategy<br/>(ä¾å‹•çˆ»æ•¸é‡æ±ºå®šç­–ç•¥)
    O->>J: ä¾ hex_id + line_number<br/>æŠ½å–ç¶“æ–‡
    J-->>O: æœ¬å¦ï¼‹ä¹‹å¦ï¼‹å‹•çˆ»åŸæ–‡
    
    O->>O: å»ºç«‹ç³»çµ±æç¤º<br/>(å«è²/æ‚”æ¡†æ¶)
    O->>G: generate_content(system_prompt)
    G-->>O: çµæ§‹åŒ–å›ç­” (Markdown)
    
    O-->>D: åœå¦è§£è®€
    D-->>U: é¡¯ç¤ºçµæœ<br/>(Kç·šåœ– + å¦è±¡ + è§£è®€)

    </div>
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
</body>
</html>